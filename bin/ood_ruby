#!/usr/bin/env bash

# Open OnDemand Ruby wrapper script
#
# The purpose of this script is to wrap up the necessary environment for the
# per-user NGINX (PUN) processes to run under. The PUN requires the following
# software in its environment:
#
# - nginx 1.6
# - passenger 4.0
# - ruby 2.2
# - node.js 0.10
# - git 1.9
#

# Allow admin to override the environment the PUN runs in
#
NGINX_ENV=${NGINX_ENV:-/etc/ood/env}
if [[ -f "${NGINX_ENV}" ]]; then
  # Source in the custom environment
  source "${NGINX_ENV}"
else
  # For Software Collections 2.0
  #
  # 1. Read in environment variable SCL_PKGS which may be set in `sudo` call
  #    otherwise fallback to default software collection packages.
  #
  # 2. Check if Software Collections is installed, then source the defined
  #    package scripts.
  #
  SCL_PKGS=${SCL_PKGS:-"nginx16 rh-passenger40 rh-ruby22 nodejs010 git19"}
  SCL_SOURCE="$(command -v scl_source)"
  [[ ${SCL_SOURCE} ]] && source "${SCL_SOURCE}" enable ${SCL_PKGS}
fi

# Environment is set, so call Ruby now
#
exec /usr/bin/env ruby "$@"
